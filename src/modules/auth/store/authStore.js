//\src\modules\auth\store\authStore.js
import { useEffect } from 'react';
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { supabase } from "@lib/supabaseClient";

/**
 * Store de autentica√ß√£o com Zustand
 */
export const useAuthStore = create(
  persist(
    (set, get) => ({
      // Estado inicial
      user: null,
      session: null,
      isAuthenticated: false,
      loading: false,
      error: null,
      initialized: false,

      // A√ß√µes de autentica√ß√£o
      setUser: (user) => {
        set({ 
          user, 
          isAuthenticated: !!user 
        });
      },

      setSession: (session) => {
        set({ 
          session,
          user: session?.user || null,
          isAuthenticated: !!session?.user
        });
      },

      setLoading: (loading) => {
        set({ loading });
      },

      setError: (error) => {
        set({ error });
      },

      setInitialized: (initialized) => {
        set({ initialized });
      },

      clearError: () => {
        set({ error: null });
      },

      // Login tradicional
      signIn: async ({ email, password }) => {
        try {
          set({ loading: true, error: null });

          const { data, error } = await supabase.auth.signInWithPassword({
            email: email.trim(),
            password,
          });

          if (error) throw error;

          set({ 
            user: data.user,
            session: data.session,
            isAuthenticated: true,
            loading: false 
          });

          return { success: true, user: data.user, session: data.session };
        } catch (err) {
          console.error('‚ùå Erro no login:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },

      // Registro
      signUp: async ({ email, password, nome }) => {
        try {
          set({ loading: true, error: null });

          const { data, error } = await supabase.auth.signUp({
            email: email.trim(),
            password,
            options: {
              data: {
                full_name: nome.trim(),
                nome: nome.trim()
              }
            }
          });

          if (error) throw error;

          // Se o usu√°rio foi criado mas precisa confirmar email
          if (data.user && !data.session) {
            set({ loading: false });
            return {
              success: true,
              user: data.user,
              needsConfirmation: true,
              message: 'Verifique seu email para confirmar a conta'
            };
          }

          set({ 
            user: data.user,
            session: data.session,
            isAuthenticated: true,
            loading: false 
          });

          return { success: true, user: data.user, session: data.session };
        } catch (err) {
          console.error('‚ùå Erro no registro:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },
// Logout
signOut: async () => {
 try {
   set({ loading: true });
   
   const { error } = await supabase.auth.signOut();
   
   if (error) throw error;

   // ‚úÖ LIMPAR authStore
   set({ 
     user: null,
     session: null,
     isAuthenticated: false,
     loading: false,
     error: null
   });

   // ‚úÖ LIMPAR TODAS AS STORES - CAMINHOS CORRETOS
   try {
     console.log('üßπ Limpando TODAS as stores no logout...');
     
     // ‚úÖ STORES CONFIRMADAS COM CAMINHOS EXATOS
     const storeImports = await Promise.allSettled([
       // Stores principais
       import('@/modules/transacoes/store/transactionsStore').then(m => m.useTransactionsStore),
       import('@/modules/dashboard/store/dashboardStore').then(m => m.useDashboardStore || m.default),
       import('@/modules/diagnostico/store/diagnosticoPercepcaoStore').then(m => m.default),
       import('@/modules/contas/store/contasStore').then(m => m.default),
       import('@/modules/cartoes/store/useCartoesStore').then(m => m.default),
       import('@/modules/diagnostico/store/diagnosticoEmocionalStore').then(m => m.default),
       import('@/modules/diagnostico/store/diagnosticoFlowStore').then(m => m.default),
       import('@/store/uiStore').then(m => m.useUIStore || m.default),
       import('@/modules/categorias/store/categoriasStore').then(m => m.default),
     ]);

     // ‚úÖ Resetar cada store com prote√ß√£o
     storeImports.forEach((result, index) => {
       if (result.status === 'fulfilled' && result.value?.getState) {
         try {
           const store = result.value.getState();
           if (typeof store.reset === 'function') {
             store.reset();
             console.log(`‚úÖ Store ${index} resetada com sucesso`);
           } else {
             console.warn(`‚ö†Ô∏è Store ${index} n√£o tem fun√ß√£o reset`);
           }
         } catch (resetError) {
           console.warn(`‚ö†Ô∏è Erro ao resetar store ${index}:`, resetError.message);
         }
       } else if (result.status === 'rejected') {
         console.warn(`‚ö†Ô∏è Falha ao importar store ${index}:`, result.reason?.message);
       }
     });
     
     // ‚úÖ Limpar localStorage relacionado ao usu√°rio
     console.log('üóëÔ∏è Limpando localStorage...');
     const keysToRemove = [];
     
     for (let i = 0; i < localStorage.length; i++) {
       const key = localStorage.key(i);
       if (key && (
         key.includes('auth-storage') || 
         key.includes('diagnostico') || 
         key.includes('dashboard') ||
         key.includes('contas') ||
         key.includes('transacoes') ||
         key.includes('cartoes') ||
         key.includes('categorias') ||
         key.includes('user-') ||
         key.includes('ipoupei-')
       )) {
         keysToRemove.push(key);
       }
     }
     
     keysToRemove.forEach(key => {
       try {
         localStorage.removeItem(key);
         console.log(`üóëÔ∏è Removido: ${key}`);
       } catch (e) {
         console.warn(`‚ö†Ô∏è Erro ao remover ${key}:`, e.message);
       }
     });
     
     // ‚úÖ Eventos globais para limpeza
     window.dispatchEvent(new CustomEvent('user-logout-complete'));
     window.dispatchEvent(new CustomEvent('clear-all-caches'));
     
     console.log(`‚úÖ LOGOUT COMPLETO: ${storeImports.length} stores processadas, ${keysToRemove.length} chaves removidas`);
     
   } catch (globalError) {
     console.error('‚ùå Erro cr√≠tico durante logout:', globalError);
   }

   // ‚úÖ FOR√áA RELOAD IMEDIATO PARA GARANTIR LIMPEZA TOTAL
   console.log('üîÑ For√ßando reload da p√°gina para limpeza total...');
   window.location.href = '/login';

 } catch (err) {
   console.error('‚ùå Erro no logout:', err);
   set({ error: 'Erro ao fazer logout', loading: false });
   
   // ‚úÖ FALLBACK: Reload mesmo em caso de erro
   console.log('üîÑ Erro no logout - for√ßando reload por seguran√ßa...');
   window.location.href = '/login';
 }
},

      // Recupera√ß√£o de senha
      resetPassword: async (email) => {
        try {
          set({ loading: true, error: null });

          const { error } = await supabase.auth.resetPasswordForEmail(email.trim(), {
            redirectTo: `${window.location.origin}/reset-password`
          });

          if (error) throw error;

          set({ loading: false });
          return { success: true };
        } catch (err) {
          console.error('‚ùå Erro na recupera√ß√£o de senha:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },

      // Atualizar senha
      updatePassword: async (newPassword) => {
        try {
          set({ loading: true, error: null });

          const { error } = await supabase.auth.updateUser({
            password: newPassword
          });

          if (error) throw error;

          set({ loading: false });
          return { success: true };
        } catch (err) {
          console.error('‚ùå Erro ao atualizar senha:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },

      // Atualizar perfil
      updateProfile: async (userData) => {
        try {
          set({ loading: true, error: null });

          const currentUser = get().user;
          if (!currentUser) throw new Error('Usu√°rio n√£o encontrado');

          // Atualizar dados de autentica√ß√£o se necess√°rio
          const authUpdates = {};
          if (userData.email && userData.email !== currentUser.email) {
            authUpdates.email = userData.email;
          }

          if (Object.keys(authUpdates).length > 0) {
            const { error: authError } = await supabase.auth.updateUser(authUpdates);
            if (authError) throw authError;
          }

          // Atualizar perfil na tabela personalizada
          const { data, error } = await supabase
            .from('perfil_usuario')
            .update({
              ...userData,
              updated_at: new Date().toISOString()
            })
            .eq('id', currentUser.id)
            .select()
            .single();

          if (error) throw error;

          // Atualizar o estado local
          set({ 
            user: { ...currentUser, ...userData },
            loading: false 
          });

          return { success: true, profile: data };
        } catch (err) {
          console.error('‚ùå Erro ao atualizar perfil:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },

      // Login com Google
      signInWithGoogle: async () => {
        try {
          set({ loading: true, error: null });

          const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: `${window.location.origin}/dashboard`
            }
          });

          if (error) throw error;

          return { success: true };
        } catch (err) {
          console.error('‚ùå Erro no login com Google:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },

      // Login com GitHub
      signInWithGitHub: async () => {
        try {
          set({ loading: true, error: null });

          const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'github',
            options: {
              redirectTo: `${window.location.origin}/dashboard`
            }
          });

          if (error) throw error;

          return { success: true };
        } catch (err) {
          console.error('‚ùå Erro no login com GitHub:', err);
          const errorMessage = get().getAuthErrorMessage(err);
          set({ error: errorMessage, loading: false });
          return { success: false, error: errorMessage };
        }
      },

      // Inicializar autentica√ß√£o
      initAuth: async () => {
        try {
          console.log('üîê Inicializando autentica√ß√£o...');
          set({ loading: true });

          // Timeout de seguran√ßa
          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('Timeout na inicializa√ß√£o')), 10000);
          });

          // Obter sess√£o atual
          const sessionPromise = supabase.auth.getSession();

          const { data: { session }, error } = await Promise.race([
            sessionPromise,
            timeoutPromise
          ]);

          if (error) {
            console.warn('‚ö†Ô∏è Erro ao obter sess√£o (n√£o cr√≠tico):', error);
          }

          console.log('üìã Sess√£o obtida:', session ? `Usu√°rio: ${session.user?.email}` : 'Nenhuma sess√£o');

          set({
            session,
            user: session?.user || null,
            isAuthenticated: !!session?.user,
            loading: false,
            initialized: true
          });

          // Se h√° usu√°rio, garantir perfil existe (em background)
          if (session?.user) {
            get().ensureUserProfile(session.user).catch(err => {
              console.warn('‚ö†Ô∏è Erro ao verificar perfil (n√£o cr√≠tico):', err);
            });
          }

          console.log('‚úÖ Autentica√ß√£o inicializada');
        } catch (err) {
          console.error('‚ùå Erro inesperado ao inicializar auth:', err);
          set({
            user: null,
            session: null,
            isAuthenticated: false,
            loading: false,
            initialized: true
          });
        }
      },

      // Garantir que o perfil do usu√°rio existe
      ensureUserProfile: async (user) => {
        try {
          console.log('üë§ Verificando perfil do usu√°rio:', user.email);

          // Verificar se perfil j√° existe
          const { data: existingProfile, error: fetchError } = await supabase
            .from('perfil_usuario')
            .select('*')
            .eq('id', user.id)
            .single();

          if (fetchError && fetchError.code !== 'PGRST116') {
            console.warn('‚ö†Ô∏è Erro ao buscar perfil (n√£o cr√≠tico):', fetchError);
            return;
          }

          // Se perfil n√£o existe, criar um novo
          if (!existingProfile) {
            console.log('‚ûï Criando perfil para usu√°rio:', user.email);

            const profileData = {
              id: user.id,
              nome: user.user_metadata?.full_name || 
                    user.user_metadata?.name || 
                    user.email?.split('@')[0] || 
                    'Usu√°rio',
              email: user.email,
              avatar_url: user.user_metadata?.avatar_url || null,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString()
            };

            const { error: insertError } = await supabase
              .from('perfil_usuario')
              .insert([profileData]);

            if (insertError) {
              console.warn('‚ö†Ô∏è Erro ao criar perfil (n√£o cr√≠tico):', insertError);
            } else {
              console.log('‚úÖ Perfil criado com sucesso para:', user.email);
              
              // Criar categorias padr√£o (em background)
              //get().createDefaultCategories(user.id).catch(err => {
                //console.warn('‚ö†Ô∏è Erro ao criar categorias padr√£o (n√£o cr√≠tico):', err);
             // });
            }
          } else {
            console.log('‚úÖ Perfil j√° existe para:', user.email);
          }
        } catch (err) {
          console.warn('‚ö†Ô∏è Erro ao garantir perfil do usu√°rio (n√£o cr√≠tico):', err);
        }
      },


      // Fun√ß√£o auxiliar para tratar mensagens de erro
      getAuthErrorMessage: (error) => {
        switch (error.message || error.code) {
          case 'Invalid login credentials':
            return 'Email ou senha incorretos';
          case 'Email not confirmed':
            return 'Confirme seu email antes de fazer login';
          case 'User already registered':
            return 'Este email j√° est√° cadastrado';
          case 'Weak password':
            return 'A senha deve ter pelo menos 6 caracteres';
          case 'Invalid email':
            return 'Email inv√°lido';
          case 'Signup disabled':
            return 'Cadastro desabilitado temporariamente';
          case 'Email rate limit exceeded':
            return 'Muitas tentativas. Tente novamente mais tarde';
          default:
            return error.message || 'Erro desconhecido';
        }
      },

      // Selectors (computed values)
      getUserName: () => {
        const { user } = get();
        return user?.user_metadata?.full_name || 
               user?.user_metadata?.name || 
               user?.email?.split('@')[0] || 
               'Usu√°rio';
      },

      getUserEmail: () => {
        const { user } = get();
        return user?.email || '';
      },

      isAdmin: () => {
        const { user } = get();
        return user?.user_metadata?.role === 'admin' || false;
      }
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        user: state.user,
        session: state.session,
        isAuthenticated: state.isAuthenticated
      })
    }
  )
);

// Hook separado que usa React.useEffect
// SUBSTITUIR COMPLETAMENTE a fun√ß√£o verificarERedirecionarDiagnostico

const verificarERedirecionarDiagnostico = async (userId) => {
  try {
    console.log('üîç === IN√çCIO VERIFICA√á√ÉO DIAGN√ìSTICO ===');
    console.log('üîç UserId:', userId);
    console.log('üîç URL atual:', window.location.href);
    console.log('üîç Pathname:', window.location.pathname);
    
    // ‚úÖ PROTE√á√ÉO 1: Verificar se √© refresh muito recente
    const lastLoginCheck = sessionStorage.getItem('last-login-check');
    const currentTime = Date.now();
    
    if (lastLoginCheck && (currentTime - parseInt(lastLoginCheck)) < 10000) {
      console.log('üîÑ REFRESH/RELOAD DETECTADO - Pulando verifica√ß√£o (menos de 10s)');
      return;
    }
    
    // ‚úÖ PROTE√á√ÉO 2: N√£o verificar em rotas especiais
    const currentPath = window.location.pathname;
    const rotasEspeciais = [
      '/diagnostico', 
      '/login', 
      '/auth/callback', 
      '/reset-password',
      '/susto-consciente'
    ];
    
    if (rotasEspeciais.some(rota => currentPath.startsWith(rota))) {
      console.log('üìç ROTA ESPECIAL DETECTADA - Pulando:', currentPath);
      return;
    }
    
    // ‚úÖ PROTE√á√ÉO 3: Verificar se j√° est√° verificando
    const verificandoKey = `verificando-diagnostico-${userId}`;
    if (sessionStorage.getItem(verificandoKey)) {
      console.log('üîÑ VERIFICA√á√ÉO J√Å EM ANDAMENTO - Pulando');
      return;
    }
    
    // ‚úÖ PROTE√á√ÉO 4: S√≥ verificar em rotas espec√≠ficas (root ou dashboard)
    const rotasQueVerificam = ['/', '/dashboard'];
    if (!rotasQueVerificam.includes(currentPath)) {
      console.log('üìç ROTA N√ÉO REQUER VERIFICA√á√ÉO:', currentPath);
      return;
    }
    
    console.log('‚úÖ TODAS AS PROTE√á√ïES PASSARAM - Prosseguindo com verifica√ß√£o');
    sessionStorage.setItem(verificandoKey, 'true');
    sessionStorage.setItem('last-login-check', currentTime.toString());
    
    // Aguardar estabilidade
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Buscar etapa do diagn√≥stico
    console.log('üîç Consultando banco de dados...');
    const { data, error } = await supabase
      .from('perfil_usuario')
      .select('diagnostico_etapa_atual')
      .eq('id', userId)
      .single();

    if (error) {
      console.error('‚ùå ERRO AO BUSCAR ETAPA:', error);
      sessionStorage.removeItem(verificandoKey);
      return;
    }

    const etapaAtual = data?.diagnostico_etapa_atual || 0;
    
    console.log('üìã === RESULTADO DA CONSULTA ===');
    console.log('üìã Etapa atual no banco:', etapaAtual);
    console.log('üìã Precisa completar diagn√≥stico:', etapaAtual < 9);
    
    if (etapaAtual < 9) {
      console.log('üîÑ === EXECUTANDO REDIRECIONAMENTO ===');
      console.log('üîÑ Salvando etapa no sessionStorage:', etapaAtual);
      
      // Salvar etapa para o DiagnosticoRouter
      sessionStorage.setItem('diagnostico-etapa-redirect', etapaAtual.toString());
      
      // Limpar flag
      sessionStorage.removeItem(verificandoKey);
      
      console.log('üîÑ Redirecionando para diagn√≥stico...');
      window.location.replace('/diagnostico');
      
    } else {
      console.log('‚úÖ DIAGN√ìSTICO COMPLETO - Usu√°rio pode continuar normalmente');
      sessionStorage.removeItem(verificandoKey);
    }
    
  } catch (error) {
    console.error('‚ùå ERRO INESPERADO NA VERIFICA√á√ÉO:', error);
    sessionStorage.removeItem(`verificando-diagnostico-${userId}`);
  }
};
// Hook separado que usa React.useEffect
// SUBSTITUIR COMPLETAMENTE o useAuthListener no authStore.js

export const useAuthListener = () => {
  const { setSession, initAuth } = useAuthStore();

  useEffect(() => {
    // Inicializar auth
    initAuth();

    // Configurar listener para mudan√ßas de autentica√ß√£o
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('üîÑ Auth state changed:', event, session?.user?.email || 'sem usu√°rio');
      setSession(session);

      // ‚úÖ L√ìGICA CORRIGIDA: Tratar cada evento separadamente
      if (event === 'SIGNED_IN' && session?.user) {
        console.log('üîë EVENTO DE LOGIN DETECTADO');
        
        // Criar perfil se necess√°rio
        useAuthStore.getState().ensureUserProfile(session.user).catch(err => {
          console.warn('‚ö†Ô∏è Erro ao criar perfil (n√£o cr√≠tico):', err);
        });

        // ‚úÖ VERIFICAR DIAGN√ìSTICO APENAS EM LOGIN REAL
        console.log('üîç Iniciando verifica√ß√£o de diagn√≥stico...');
        setTimeout(() => {
          verificarERedirecionarDiagnostico(session.user.id).catch(err => {
            console.warn('‚ö†Ô∏è Erro ao verificar diagn√≥stico (n√£o cr√≠tico):', err);
          });
        }, 2000);
        
      } else if (event === 'SIGNED_OUT') {
        console.log('üö™ EVENTO DE LOGOUT');
        // Limpar cache de verifica√ß√£o
        sessionStorage.removeItem('last-login-check');
        console.log('üßπ Cache de login limpo');
        
      } else if (event === 'TOKEN_REFRESHED' && session?.user) {
        console.log('üîÑ TOKEN ATUALIZADO - N√ÉO VERIFICAR DIAGN√ìSTICO');
        // Token refresh n√£o deve verificar diagn√≥stico
        
      } else {
        console.log(`üîÑ Evento ${event} - Sem a√ß√£o especial`);
      }
    });

    return () => {
      subscription.unsubscribe();
    };
  }, [setSession, initAuth]);
};

export default useAuthStore;